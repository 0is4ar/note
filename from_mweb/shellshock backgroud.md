# shellshock backgroud

[TOC]

## environmnet variable 


An environment variable is a value that can affect the way processes run, and is usually used to provide context when executing a program, like `$PATH`, `$HOME`. In most cases, child process inherits environment variables from parent process. And process could also pass new environment variable to child process.

you can find some ways to pass environment variable to child process in bash at http://hackjutsu.com/2016/08/04/Difference%20between%20set,%20export%20and%20env%20in%20bash/


## CGI 

Instead of using only HTML and Javascript which only return "static" content, CGI protocol was designed for web server to use other programming languages to generate more interesting content.

Basically, a CGI program simply a script, like a python script, or bash script, when web server invokes it, the script will be executed and return its standard output(like echo 'something')to web server, then web sever makes some further process and returning the content back to user. 

CGI script could be written in any language, so you have to indicate which interpreter should be used in order to execute the program, this could be specified by things like `#!/usr/bin/python` or `#!/bin/bash_shellshock` on the top of scripts(https://en.wikipedia.org/wiki/Shebang_(Unix) )


## environment variable passing in CGI

When user requests a file needs to be generated by CGI. Web server "calls" CGI program, and tries to provide the CGI program(its child process) with some context of the request by passing some environment variable to CGI program, like "HTTP_USER_AGENT".

## Shellshock

the shellshock vulnerability exists in `bash` program, when child bash tries to "accept" environment variables passed from its parent process, it checks those variables. When a variable's format looks like a bash function even though it's actually a string, it will try to parse and execute the string.

code snippet in bash program: 
```C
 if (privmode == 0 && read_but_dont_execute == 0 && STREQN ("() {", string, 4)) { 
     [...] 
     parse_and_execute (temp_string, name, 
       SEVAL_NONINT|SEVAL_NOHIST); 
```

## basic logic

-> User requests a CGI program with HTTP header "user agent" which looks like a function(use curl).

-> Web Server gets the request from user, call CGI program with passing "user agent" as one of environment variable.

-> CGI program(a bash program here) accept "user agent" from web server, and because it's vulnerable, it parse and executes "user agent" we passed.
